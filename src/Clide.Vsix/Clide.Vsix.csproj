<Project Sdk="Microsoft.NET.Sdk" InitialTargets="FixupVsixDependencies">
  <PropertyGroup>
    <TargetFramework Condition="'$(BuildingInsideVisualStudio)' == 'true' and '$(VisualStudioVersion)' == '15.0'">net462</TargetFramework>
    <TargetFramework Condition="'$(BuildingInsideVisualStudio)' == 'true' and '$(VisualStudioVersion)' == '14.0'">net461</TargetFramework>
    <TargetFramework Condition="'$(TargetFramework)' == '' and '$(CI)' == 'true'">net461</TargetFramework>
    <TargetFrameworks Condition="'$(TargetFramework)' == '' and '$(CI)' == 'false'">net461;net462</TargetFrameworks>

    <IncludePack>true</IncludePack>
    <TargetVsixContainerName>Clide.vsix</TargetVsixContainerName>
    <IsProductComponent>true</IsProductComponent>
    <BypassVsixValidation Condition="'$(CI)' == 'true'">true</BypassVsixValidation>

    <PackageId>Clide</PackageId>
    <Authors>kzu, Daniel Cazzulino</Authors>
    <Owners>clariuslabs, kzu</Owners>
    <Description>Clide</Description>
    <Copyright>Copyright 2012 Clarius Labs</Copyright>

    <InferPackageContents>false</InferPackageContents>
    <PackOnBuild Condition="'$(Configuration)' == 'Release'">true</PackOnBuild>
  </PropertyGroup>

  <!-- Dynamic manifest info -->
  <ItemGroup>
    <!-- We need this since IsSystemComponent can't be specified if the VSIX is built by the 14.0 VSSDK -->
    <VsixInstallation Include="Clide" IsSystemComponent="$(CI)" Condition="'$(VsSDKVersion)' != '' and '$(VsSDKVersion)' &gt; '14.0' " />
  </ItemGroup>
  
  <ItemGroup>
    <None Include="source.extension.vsixmanifest" />
    <PackageFile Include="build\*.*" Kind="Build" />
    <BindingRedirect Include="Clide" From="3.0.0.0" To="99.9.9.9" />
  </ItemGroup>

  <ItemGroup>
    <PackageReference Include="Xamarin.VSSDK.BuildTools" Version="0.3.0-alpha.*" Condition="'$(CI)' != 'true'" />
    <PackageReference Include="Xamarin.VSSDK.BuildTools" Version="0.3.0-alpha.15" Condition="'$(CI)' == 'true'" />
    <!-- Always build with latest VSSDK in CI -->
    <PackageReference Include="Microsoft.VSSDK.BuildTools" Version="15.1.192" Condition="'$(CI)' == 'true'" />
  </ItemGroup>

  <ItemGroup>
    <ProjectReference Include="..\Clide.Interfaces\Clide.Interfaces.csproj" />
    <ProjectReference Include="..\Clide\Clide.csproj" Pack="false" />
    <ProjectReference Include="..\Clide.Extensibility\Clide.Extensibility.csproj" Pack="false" />
  </ItemGroup>

  <Target Name="AddPackageContents" BeforeTargets="GetPackageContents">
    <ItemGroup>
      <PackageFile Include="$(TargetVsixContainer)" Kind="Tools" />
    </ItemGroup>
  </Target>

  <Target Name="IncludeSymbolsFromProjectReferences" BeforeTargets="GetVsixSourceItems">
    <!-- For any project references that are set to copy local ('Private' property != false), add the output groups for project references that are not set -->
    <ItemGroup>
      <ProjectReferenceWithConfiguration Condition="'%(ProjectReferenceWithConfiguration.Private)' != 'false' and '%(ProjectReferenceWithConfiguration.IncludeOutputGroupsInVSIX)' == ''">
        <IncludeOutputGroupsInVSIX>$(DefaultIncludeOutputGroupsInVSIX)</IncludeOutputGroupsInVSIX>
      </ProjectReferenceWithConfiguration>
    </ItemGroup>
  </Target>

  <!-- We always build as SystemComponent on CI -->
  <Target Name="IsSystemComponent" Returns="$(CI)" />

  <Target Name="FixupVsixDependencies">
    <ItemGroup>
      <VsixDependency Remove="@(VsixDependency)" />
    </ItemGroup>
  </Target>

  <Target Name="GetVsixVersion" Returns="$(VsixVersion)" DependsOnTargets="SetVersion">
    <PropertyGroup>
      <VsixVersion Condition="'$(Configuration)' == 'Debug'">42.42.42</VsixVersion>
      <VsixVersion Condition="'$(VsixVersion)' == ''">$(AssemblyVersion)</VsixVersion>
    </PropertyGroup>
  </Target>

  <Target Name="AppendVsixVersionToTargetVsixContainer" BeforeTargets="CreateVsixContainer" DependsOnTargets="GetVsixVersion">
    <PropertyGroup>
      <TargetVsixContainer>$([System.IO.Path]::ChangeExtension('$(TargetVsixContainer)', '$(VsixVersion).vsix'))</TargetVsixContainer>
    </PropertyGroup>
  </Target>

  <Target Name="CopyVsixToPackageOutputPath" AfterTargets="CreateVsixContainer" Condition="'$(PackageOutputPath)' != '' and '$(CreateVsixContainer)' == 'true'">
    <Copy SourceFiles="$(TargetVsixContainer)" DestinationFolder="$(PackageOutputPath)" />
    <Message Importance="high" Text="Copied extension to $(PackageOutputPath)\$([System.IO.Path]::GetFilename('$(TargetVsixContainer)'))" />
  </Target>


</Project>
